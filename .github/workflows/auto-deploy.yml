name: Auto Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'DEPLOY_GUIDE.md'
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Check SSH secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "::error::Required SSH secrets are not configured."
            echo "Please set: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY"
            exit 1
          fi
          echo "âœ“ SSH secrets configured"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 5m
          script: |
            set -e

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_PATH="${DEPLOY_PATH:-/home/admin/domains/demo87.xman4289.com/mdt}"

            echo "ðŸš€ Starting deployment to ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            # Backup .env
            cp .env .env.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Install/update composer dependencies (use update to resolve version conflicts)
            echo "ðŸ“¦ Installing composer dependencies..."
            composer update --no-dev --optimize-autoloader --no-interaction 2>&1 || {
              echo "âš ï¸ Composer update failed, trying install with --ignore-platform-reqs"
              composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs 2>&1 || {
                echo "âš ï¸ Composer failed but continuing deployment..."
              }
            }

            # Run migrations (if any)
            echo "ðŸ—ƒï¸ Running migrations..."
            php artisan migrate --force 2>&1 || echo "âš ï¸ Migration warnings (non-fatal)"

            # Clear and rebuild caches
            echo "âš¡ Optimizing application..."
            php artisan config:clear 2>/dev/null || true
            php artisan route:clear 2>/dev/null || true
            php artisan view:clear 2>/dev/null || true
            php artisan config:cache 2>/dev/null || true
            php artisan route:cache 2>/dev/null || true
            php artisan view:cache 2>/dev/null || true
            php artisan event:cache 2>/dev/null || true

            # Fix permissions
            chmod -R 775 storage bootstrap/cache 2>/dev/null || true

            # Restart queue workers if running
            php artisan queue:restart 2>/dev/null || true

            echo "âœ… Deployment completed successfully!"

      - name: Health Check
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: |
          URL="${APP_URL:-https://demo87.xman4289.com}"
          echo "ðŸ” Checking health at: ${URL}/login"
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/login" || echo "000")
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Application is healthy (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Health check returned HTTP $HTTP_CODE (may still be starting up)"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
